<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no" />
<title>Childbrowser PhoneGap Native App - jQuery Mobile</title>
<link href="jquery-mobile/jquery.mobile.theme-1.1.0.min.css" rel="stylesheet" type="text/css"/>
<link href="jquery-mobile/jquery.mobile.structure-1.1.0.min.css" rel="stylesheet" type="text/css"/>

 <script type="text/javascript" src="pdf.js"></script>
  <script type="text/javascript">
    PDFJS.workerSrc = 'pdf.js';
  </script>

<script src="jquery-mobile/jquery.js" type="text/javascript"></script>
<script src="jquery-mobile/jquery.mobile-1.1.0.min.js" type="text/javascript"></script>
<script src="phonegap.js"></script>
<script src="childbrowser.js"></script>
</head>
<body>
<div data-role="page" id="page">
  <div data-role="header">
    <h1>ChildBrowser 7</h1>
  </div>
  <div data-role="content">
    <div data-role="controlgroup"><a href="#" onclick="bajaPDF();" data-role="button" data-inline="false">bajar FIC</a></div>
    <div data-role="controlgroup"><a href="#" onclick="window.plugins.childBrowser.showWebPage('http://www.google.com',{showLocationBar:true});" data-role="button" data-inline="false">showWebPage. Open Google.com</a></div>
    <div data-role="controlgroup"><a href="#" onclick="window.plugins.childBrowser.showWebPage(encodeURI('file:///mnt/sdcard/Download/a1.jpg'),{showLocationBar:true});" data-role="button" data-inline="false">AND.showWebPage. Open PDF SDCard</a></div>
    <div data-role="controlgroup"><a href="#" onclick="window.plugins.childBrowser.showWebPage(encodeURI('file:///Documents/a1.jpg'),{showLocationBar:true});" data-role="button" data-inline="false">iOS.showWebPage. Open PDF Documents</a></div>
    <div data-role="controlgroup"><a href="#" onclick="window.plugins.childBrowser.showWebPage(encodeURI('http://213.27.242.251:8000/AJVILA/Archivos/FOTOS/Horari.pdf'),{showLocationBar:true});" data-role="button" data-inline="false">showWebPage. Open PDF AjVila</a></div>
    <div data-role="controlgroup"><a href="#" onclick="window.plugins.childBrowser.showWebPage(encodeURI('http://docs.google.com/viewer?url=http://213.27.242.251:8000/AJVILA/Archivos/FOTOS/Horari.pdf'),{showLocationBar:true});" data-role="button" data-inline="false">showWebPage+docs.google. Open PDF AjVila</a></div>
    <div data-role="controlgroup"><a href="#" onclick="window.plugins.childBrowser.openExternal(encodeURI('http://213.27.242.251:8000/AJVILA/Archivos/FOTOS/Horari.pdf'),{showLocationBar:true});" data-role="button" data-inline="false">openExternal. Open PDF de AJVILA</a></div>
    <div data-role="controlgroup"><a href="#" onclick="window.plugins.childBrowser.openExternal(encodeURI('file:///mnt/sdcard/Download/Horari.pdf'),{showLocationBar:true});" data-role="button" data-inline="false">AND.openExternal. de SDCard</a></div>
    <div data-role="controlgroup"><a href="#" onclick="window.plugins.childBrowser.openExternal(encodeURI('file:///Documents/Horari.pdf'),{showLocationBar:true});" data-role="button" data-inline="false">iOS.openExternal. de Documents</a></div>

    <label for="txtINI">bajar de </label><input type="text" id="txtINI" name="txtINI" value = "http://213.27.242.251:8000/AJVILA/Archivos/FOTOS/" />
    <label for="txtFIN">guardar en </label><input type="text" id="txtFIN" name="txtFIN" value="file:///Documents/"/>
    <label for="visorPDF">visor iFrame</label><iframe id="visorPDF"></iframe>
    <label for="the-canvas">visor Canvas</label><canvas id="the-canvas" style="border:1px solid black;"/>
  </div>  
  <div data-role="footer">
    <h4>Page Footer</h4>
  </div>  
</div>
<script type="text/javascript">
    $(function () {
        alert('load');
        document.addEventListener("deviceready", function () {
            var filePath = $('#txtFIN').val();
            alert('device ready');
            PDFJS.getDocument(filePath).then(function (pdf) {
                alert('pillado');
                // Using promise to fetch the page
                pdf.getPage(1).then(function (page) {
                    var scale = 1.5;
                    var viewport = page.getViewport(scale);

                    //
                    // Prepare canvas using PDF page dimensions
                    //
                    var canvas = document.getElementById('the-canvas');
                    var context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    //
                    // Render PDF page into canvas context
                    //
                    var renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    page.render(renderContext);
                });
            });
    	  }());
        });

        function verEnFrame() {
            alert('en el frame ?');
            var filePath = $('#txtFIN').val();
            $('#visorPDF').attr("src", filePath);
            //$('#visorPDF').contents().find('html').html(filePath);

            alert("ahora : window.plugins.childBrowser.openExternal(" + filePath + ");");
            window.plugins.childBrowser.openExternal(filePath);
        }

        function bajaPDF() {
            alert('bajar Fic');
            var fileTransfer = new FileTransfer();
            var uri = encodeURI($('#txtINI').val());
            var filePath = $('#txtFIN').val();
            var pathToRoot = "";
            
            window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSys) {
                pathToRoot = fileSys.root.fullPath;
                alert(pathToRoot);
                fileTransfer.download(
                uri,
                pathToRoot + "/" + filePath,
                function (entry) {
                    alert("download complete: \n" + entry.fullPath);
                },
                function (error) {
                    alert("download error source " + error.source + "   download error target " + error.target + "  upload error code" + error.code);
                }
              );
            }, function() {
             alert('****iPhone:Error when requesting persisten filesystem to find root path.');
            });
            
        }

</script>
</body>
</html>
